using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using WslAntiMalware.Communication;
using WslAntiMalware.Storage;
using WslCoreWrapper;

namespace WslAntiMalware
{
    public class SystemService
    {
        public SystemService(SettingsStorage Settings, DetectionsHistory Detections, LogsHistory Logs)
        {
            _settings = Settings;
            _detections = Detections;
            _logs = Logs;

            Task.Run(() =>
            {
                WslCoreWrapper.FilterPortWrapper filterPortWrapper = new WslCoreWrapper.FilterPortWrapper();

                try
                {
                    while (true)
                    {
                        Console.WriteLine("wait detection");
                        var name = filterPortWrapper.WaitDetection();
                        Console.WriteLine("detected");
                        var det = new Detection(name, DetectionResolutionType.Killed);
                        _callback.OnDetection(det);
                        _detections.Add(det);
                    }
                }
                catch (Exception ex)
                {
                    Console.WriteLine(ex.Message);
                    Console.WriteLine(ex.ToString());
                }
            });
        }

        public void Configure(ServiceEndpoint Endpoint)
        {
            _callback = Endpoint.Callback;
            Endpoint.ClientRegistered += OnClientRegister;
        }

        private void OnClientRegister(object Sender, ClientEventArgs Event)
        {
            ServiceEndpoint endpoint = Sender as ServiceEndpoint;
            endpoint.StartMonitoringRequested += OnStartMonitoring;
            endpoint.StopMonitoringRequested += OnStopMonitoring;
            endpoint.DetectionsRequested += OnDetectionsRequest;
            endpoint.LogsRequested += OnLogsRequest;
            endpoint.SettingsRequested += OnSettingsRequest;
        }

        private void OnStartMonitoring(object Sender, ClientEventArgs Event)
        {
            Console.WriteLine("start");
            _settings.MonitoringState = true;
        }

        private void OnStopMonitoring(object Sender, ClientEventArgs Event)
        {
            Console.WriteLine("stop");
            _settings.MonitoringState = false;
        }

        private void OnDetectionsRequest(object Sender, ClientDetectionRequestEventArgs Event)
        {
            Console.WriteLine("detections");
            Event.Detections.AddRange(_detections.Detections);
        }

        private void OnLogsRequest(object Sender, ClientLogsRequestEventArgs Event)
        {
            Console.WriteLine("logs");
            Event.Logs.AddRange(_logs.Logs);
        }

        private void OnSettingsRequest(object Sender, ClientSettingsRequestEventArgs Event)
        {
            Console.WriteLine("settings");
            Event.Settings.IsMonitoringOn = _settings.MonitoringState;
            Event.Settings.IsElevatedWslAllowed = false;
        }

        private ISystemServiceMessages _callback;
        private SettingsStorage _settings;
        private DetectionsHistory _detections;
        private LogsHistory _logs;
        //private AppServiceConnection c;
    }
}
